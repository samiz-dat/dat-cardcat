{"version":3,"sources":["../src/dat.js"],"names":["listDatContents","dat","archive","archiveList","promisify","list","context","DatWrapper","constructor","opts","exitHandler","options","error","cleanup","console","log","leave","stack","exit","process","directory","existsSync","mkdirSync","key","name","run","create","then","toString","network","joinNetwork","stats","trackStats","once","gray","bold","get","peers","createDatAsync","importFiles","resolve","reject","owner","importer","on","listContents","downloadContent","fn","download"],"mappings":";;;;;;;;AAQgBA,e,GAAAA,e,CARhB,wB,uCACA,mC,iDAEA,oC,mDACA,8B,6CACA,4C,8lBAHA;AAKA;AACO,SAASA,eAAT,CAAyBC,GAAzB,EAA8B,CACnC,MAAMC,UAAUD,IAAIC,OAApB,CACA,MAAMC,cAAc,mBAAQC,SAAR,CAAkBF,QAAQG,IAA1B,EAAgC,EAAEC,SAASJ,OAAX,EAAhC,CAApB;AACA,SAAOC,aAAP;AACD;;AAED;AACA;AACA;;AAEA;;;;AAIe,MAAMI,UAAN,CAAiB;AAC9BC,cAAYC,IAAZ,EAAkB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoElBC,eApEkB,GAoEJC,WAAYC,KAAD,IAAW;AAClC,UAAID,QAAQE,OAAZ,EAAqB;AACnBC,gBAAQC,GAAR,CAAY,cAAZ;AACA,YAAI,KAAKd,GAAT,EAAc,KAAKA,GAAL,CAASe,KAAT;AACf;AACD,UAAIJ,KAAJ,EAAWE,QAAQC,GAAR,CAAYH,MAAMK,KAAlB;AACX,UAAIN,QAAQO,IAAZ,EAAkBC,QAAQD,IAAR;AACnB,KA3EiB,CAChB,KAAKE,SAAL,GAAiBX,KAAKW,SAAtB,CADgB,CAEhB;AACA,QAAI,CAAC,aAAGC,UAAH,CAAcZ,KAAKW,SAAnB,CAAL,EAAoC,CAClC,aAAGE,SAAH,CAAab,KAAKW,SAAlB,EACD,CACD,KAAKG,GAAL,GAAWd,KAAKc,GAAhB,CACA,KAAKC,IAAL,GAAYf,KAAKe,IAAjB,CACA,KAAKf,IAAL,GAAYA,IAAZ,CACD,CAV6B,CAY9B;AACA;AACA;AACAgB,QAAM,CACJ,OAAO,KAAKC,MAAL,GACJC,IADI,CACE1B,GAAD,IAAS,CACb,KAAKA,GAAL,GAAWA,GAAX,CACA,KAAKsB,GAAL,GAAWtB,IAAIsB,GAAJ,CAAQK,QAAR,CAAiB,KAAjB,CAAX,CAFa,CAGb;AACA,YAAMC,UAAU5B,IAAI6B,WAAJ,EAAhB,CACA,MAAMC,QAAQ9B,IAAI+B,UAAJ,EAAd,CACAD,MAAME,IAAN,CAAW,QAAX,EAAqB,MAAM,CACzBnB,QAAQC,GAAR,CAAY,gBAAMmB,IAAN,CAAW,gBAAMC,IAAN,CAAW,eAAX,CAAX,CAAZ,EAAqDJ,MAAMK,GAAN,EAArD,EACD,CAFD,EAGAP,QAAQI,IAAR,CAAa,YAAb,EAA2B,MAAM,CAC/BnB,QAAQC,GAAR,CAAY,sBAAZ,EACAD,QAAQC,GAAR,CAAY,gBAAMmB,IAAN,CAAW,gBAAMC,IAAN,CAAW,QAAX,CAAX,CAAZ,EAA8CJ,MAAMM,KAApD,EACD,CAHD,EATa,CAab;AACD,KAfI,EAgBJV,IAhBI,CAgBC,MAAM,IAhBP,CAAP,CAiBD,CAjC6B,CAmC9B;AACAD,WAAS,CACP,MAAMY,iBAAiB,mBAAQlC,SAAR,mBAAvB,CACA,OAAOkC,eAAe,KAAKlB,SAApB,EAA+B,KAAKX,IAApC,CAAP,CACD,CAED8B,cAAc,CACZ,OAAO,uBAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB,CACtC,MAAMxC,MAAM,KAAKA,GAAjB,CACA,IAAI,KAAKA,GAAL,CAASyC,KAAb,EAAoB,CAClB,MAAMC,WAAW1C,IAAIsC,WAAJ,CAAgB,KAAKnB,SAArB,EAAgC,MAAM,CACrDN,QAAQC,GAAR,CAAa,+BAA8B,KAAKK,SAAU,EAA1D,EACAoB,QAAQ,IAAR,EACD,CAHgB,CAAjB,CAIAG,SAASC,EAAT,CAAY,OAAZ,EAAqBH,MAArB,EACD,CAND,MAMO,CACLD,QAAQ,KAAR,EACD,CACF,CAXM,CAAP,CAYD,CAtD6B,CAwD9B;AACAK,iBAAe,CACb,MAAM3C,UAAU,KAAKD,GAAL,CAASC,OAAzB,CACA,MAAMC,cAAc,mBAAQC,SAAR,CAAkBF,QAAQG,IAA1B,EAAgC,EAAEC,SAASJ,OAAX,EAAhC,CAApB,CACA,OAAOC,aAAP,CACD,CA7D6B,CA+D9B;AACM2C,iBAAN,CAAsBC,KAAK,EAA3B,EAA+B,yDAC7BjC,QAAQC,GAAR,CAAa,iBAAgBgC,EAAG,EAAhC,EACA,MAAM,sBAAIC,QAAJ,CAAa,MAAK/C,GAAL,CAASC,OAAtB,EAA+B6C,EAA/B,CAAN,CAF6B,KAG9B,CAnE6B,C,kBAAXxC,U","file":"dat.js","sourcesContent":["import fs from 'fs';\nimport createDat from 'dat-node';\n// import _ from 'lodash';\nimport Promise from 'bluebird';\nimport chalk from 'chalk';\nimport pda from 'pauls-dat-api';\n\n// Lists the contents of a dat\nexport function listDatContents(dat) {\n  const archive = dat.archive;\n  const archiveList = Promise.promisify(archive.list, { context: archive });\n  return archiveList();\n}\n\n// export function listDatContents2(dat) {\n//   return pda.listFiles(dat.archive, '/');\n// }\n\n/**\n * Adds Library-ish functions to a Dat. Expects the Dat's directory structure to\n * follow Calibre's (Author Name/ Publication Title/ Files)\n */\nexport default class DatWrapper {\n  constructor(opts) {\n    this.directory = opts.directory;\n    // create if it doesn't exist\n    if (!fs.existsSync(opts.directory)) {\n      fs.mkdirSync(opts.directory);\n    }\n    this.key = opts.key;\n    this.name = opts.name;\n    this.opts = opts;\n  }\n\n  // Creates a dat and grabs a key\n  // Perhaps this gets rewritten to be more like beaker:\n  // https://github.com/beakerbrowser/beaker/blob/2c2336430bdb00ea8e47e13fb2e8c8d5b89440ea/app/background-process/networks/dat/dat.js#L231\n  run() {\n    return this.create()\n      .then((dat) => {\n        this.dat = dat;\n        this.key = dat.key.toString('hex');\n        // const opts = {}; // various network options could go here (https://github.com/datproject/dat-node)\n        const network = dat.joinNetwork();\n        const stats = dat.trackStats();\n        stats.once('update', () => {\n          console.log(chalk.gray(chalk.bold('stats updated')), stats.get());\n        });\n        network.once('connection', () => {\n          console.log('connects via network');\n          console.log(chalk.gray(chalk.bold('peers:')), stats.peers);\n        });\n        // this.start(dat);\n      })\n      .then(() => this);\n  }\n\n  // Just creates a dat object\n  create() {\n    const createDatAsync = Promise.promisify(createDat);\n    return createDatAsync(this.directory, this.opts);\n  }\n\n  importFiles() {\n    return new Promise((resolve, reject) => {\n      const dat = this.dat;\n      if (this.dat.owner) {\n        const importer = dat.importFiles(this.directory, () => {\n          console.log(`Finished importing files in ${this.directory}`);\n          resolve(true);\n        });\n        importer.on('error', reject);\n      } else {\n        resolve(false);\n      }\n    });\n  }\n\n  // Lists the contents of a dat\n  listContents() {\n    const archive = this.dat.archive;\n    const archiveList = Promise.promisify(archive.list, { context: archive });\n    return archiveList();\n  }\n\n  // Download a file or directory\n  async downloadContent(fn = '') {\n    console.log(`Downloading: /${fn}`);\n    await pda.download(this.dat.archive, fn);\n  }\n\n  exitHandler = options => (error) => {\n    if (options.cleanup) {\n      console.log('cleaning up!');\n      if (this.dat) this.dat.leave();\n    }\n    if (error) console.log(error.stack);\n    if (options.exit) process.exit();\n  };\n\n}\n"]}