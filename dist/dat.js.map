{"version":3,"sources":["../src/dat.js"],"names":["DatWrapper","constructor","opts","exitHandler","options","error","cleanup","console","log","dat","leave","stack","exit","process","directory","existsSync","mkdirSync","key","name","stats","latest","run","create","then","toString","network","joinNetwork","trackStats","once","gray","bold","peers","archive","metadata","on","emit","createDatAsync","promisify","importFiles","resolve","reject","writable","watch","dereference","importer","src","stat","listContents","below","readdir","recursive","downloadContent","fn","fn2","download","hasFile","file","statAsync","join","catch","e","rename","dir","renameAsync"],"mappings":"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","file":"dat.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport EventEmitter from 'events';\nimport createDat from 'dat-node';\n// import _ from 'lodash';\nimport Promise from 'bluebird';\nimport chalk from 'chalk';\nimport pda from 'pauls-dat-api';\n\n// import { lsFilesPromised } from './utils/filesystem';\n\n// fork() - download a dat and fork it (thru dat.json)\n// list() - lists files\n// download() - downloads some files\n// read/writeManifest()\n// health/ stats\n\n/**\n * Adds Library-ish functions to a Dat. Expects the Dat's directory structure to\n * follow Calibre's (Author Name/ Publication Title/ Files)\n */\nexport default class DatWrapper extends EventEmitter {\n  constructor(opts) {\n    super();\n    this.directory = opts.directory;\n    // create if it doesn't exist\n    if (!fs.existsSync(opts.directory)) {\n      fs.mkdirSync(opts.directory);\n    }\n    this.key = opts.key;\n    this.name = opts.name;\n    this.stats = false;\n    this.opts = opts;\n    // Don't need the whole history (also we do need files as files)\n    this.opts.latest = true;\n    // If we're creating/ hosting a dat, set indexing to true\n    // this.opts.indexing = !this.key;\n  }\n\n  // Creates a dat and grabs a key\n  // Perhaps this gets rewritten to be more like beaker:\n  // https://github.com/beakerbrowser/beaker/blob/2c2336430bdb00ea8e47e13fb2e8c8d5b89440ea/app/background-process/networks/dat/dat.js#L231\n  run() {\n    return this.create()\n      .then((dat) => {\n        this.dat = dat;\n        this.key = dat.key.toString('hex');\n        // const opts = {}; // various network options could go here (https://github.com/datproject/dat-node)\n        const network = dat.joinNetwork();\n        this.stats = dat.trackStats();\n        /*\n        stats.once('update', () => {\n          console.log(chalk.gray(chalk.bold('stats updated')), stats.get());\n        });\n        */\n        network.once('connection', () => {\n          console.log('connects via network');\n          console.log(chalk.gray(chalk.bold('peers:')), this.stats.peers);\n        });\n        // this.start(dat);\n        // Watch for metadata syncing\n        dat.archive.metadata.on('sync', () => {\n          console.log('metadata synced');\n          this.emit('sync metadata', this);\n        });\n      })\n      .then(() => this);\n  }\n\n  // Just creates a dat object\n  create() {\n    const createDatAsync = Promise.promisify(createDat);\n    return createDatAsync(this.directory, this.opts);\n  }\n\n  // How many peers for this dat\n  get peers() {\n    return this.stats.peers || 0;\n  }\n\n  importFiles() {\n    return new Promise((resolve, reject) => {\n      const dat = this.dat;\n      if (this.dat.writable) {\n        const opts = {\n          watch: true,\n          dereference: true,\n        };\n        const importer = dat.importFiles(this.directory, opts, () => {\n          console.log(`Finished importing files in ${this.directory}`);\n          resolve(true);\n        });\n        importer.on('error', reject);\n        // Emit event that something has been imported into the dat\n        importer.on('put', src =>\n          this.emit('import', this, src.name, src.stat));\n      } else {\n        resolve(false);\n      }\n    });\n  }\n\n  // Lists the contents of the dat\n  listContents(below = '/') {\n    return pda.readdir(this.dat.archive, below, { recursive: true });\n  }\n\n  // Download a file or directory\n  downloadContent(fn = '') {\n    const fn2 = `/${fn}/`;\n    console.log(`Downloading: ${fn2}`);\n    console.log(this.stats.peers);\n    return pda.download(this.dat.archive, fn2);\n  }\n\n  // Has the file been downloaded?\n  hasFile(file) {\n    return fs.statAsync(path.join(this.directory, file))\n      .catch(e => {});\n  }\n\n  // Rename\n  rename(dir, name) {\n    const renameAsync = Promise.promisify(fs.rename);\n    return renameAsync(this.directory, dir)\n      .then(() => {\n        this.directory = dir;\n        this.name = name;\n      });\n  }\n\n  exitHandler = options => (error) => {\n    if (options.cleanup) {\n      console.log('cleaning up!');\n      if (this.dat) this.dat.leave();\n    }\n    if (error) console.log(error.stack);\n    if (options.exit) process.exit();\n  };\n\n}\n"]}