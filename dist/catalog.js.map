{"version":3,"sources":["../src/catalog.js"],"names":["createCatalog","Catalog","constructor","baseDir","dats","db","format","dir","base","multidat","isReady","importQueue","queuing","queueBatchSize","parseInt","get","publicDatabaseFuncs","forEach","fn","args","console","warn","publicMultidatFuncs","init","databaseOnlyMode","initDatabase","then","initMultidat","getDats","initOthers","cleanupDatRegistry","each","dw","registerDat","ingestDatContents","importDir","name","importDat","key","importRemoteDat","catch","Error","log","forkDat","checkout","opts","reject","collection","getTitlesWith","rows","row","download","dat","scanForDownloads","Array","isArray","map","getDatsWith","uniq","renameDat","newPath","getDat","rename","updateDat","removeDat","deleteDir","promise","resolve","directory","pathToDat","startsWith","rimrafAsync","promisify","clearTexts","filter","bold","datkey","toString","on","handleDatImportEvent","handleDatSyncMetadataEvent","handleDatSyncCollectionsEvent","handleDatListingEvent","handleDatListingEndEvent","handleDatHistoryDataEvent","handleDatHistoryEndEvent","addDat","version","e","ingestDatCollections","clearCollections","listFlattenedCollections","item","ingestDatCollectedFile","file","collectionArr","importedData","join","addCollectedText","author","title","push","pumpContents","moveTheQueueAlong","batch","splice","length","ingestDatFile","queries","transact","finally","r","indexOf","downloaded","hasFile","downloadedStr","query","addText","author_sort","authorSort","resource","downloadFromDat","getItemsWith","doc","itemIsDownloaded","setDownloaded","dbRow","datHasFile","filePath","stat","includes","data","dataDir","dataDirFinal","process","cwd","existsSync","mkdirSync","catalog"],"mappings":"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","file":"catalog.js","sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport Promise from 'bluebird';\nimport chalk from 'chalk';\nimport _ from 'lodash';\nimport rimraf from 'rimraf'; // This will b removed soon\nimport config from './config';\n\nimport Database from './db'; // eslint-disable-line\nimport Multidat from './multidat';\n\nimport parseEntry from './utils/importers';\n// @todo: this.db.close(); should be called on shutdown\n\n// Class definition\nexport class Catalog {\n  constructor(baseDir) {\n    this.baseDir = baseDir;\n    this.dats = [];\n    this.db = new Database(path.format({\n      dir: this.baseDir,\n      base: 'catalog.db',\n    }));\n    this.multidat = new Multidat(baseDir);\n    // If you ever need to see what queries are being run uncomment the following.\n    // this.db.on('query', queryData => console.log(queryData));\n    this.isReady = false;\n\n    // For bulk imports we'll use queue\n    this.importQueue = [];\n    this.queuing = [];\n    this.queueBatchSize = parseInt(config.get('queueBatchSize'), 10);\n\n    // Now, database functions are passed on from this.db\n    // explicitly declare publicly accessible database functions\n    const publicDatabaseFuncs = [\n      'getDats',\n      'getAuthors',\n      'getCollectionAuthors',\n      'getAuthorLetters',\n      'getCollections',\n      'getTitlesWith',\n      'search',\n      'getTitlesForAuthor',\n      'setDownloaded',\n    ];\n\n    publicDatabaseFuncs.forEach((fn) => {\n      if (typeof this.db[fn] === 'function') this[fn] = (...args) => this.db[fn](...args);\n      else console.warn(`Database function \"${fn}\" does not exist and has not been attached to Catalog object.`);\n    });\n\n    const publicMultidatFuncs = ['copyFromDatToDat'];\n\n    publicMultidatFuncs.forEach((fn) => {\n      if (typeof this.multidat[fn] === 'function') this[fn] = (...args) => this.multidat[fn](...args);\n      else console.warn(`Multidat function \"${fn}\" does not exist and has not been attached to Catalog object.`);\n    });\n  }\n\n  init(databaseOnlyMode) {\n    if (databaseOnlyMode) {\n      return this.initDatabase().then(() => this);\n    }\n    return this.initDatabase()\n      .then(() => this.initMultidat())\n      .then(() => this);\n  }\n\n  initDatabase() {\n    return this.db.init();\n  }\n\n  initMultidat() {\n    return this.multidat.init()\n      .then(() => this.getDats())\n      .then(dats => this.multidat.initOthers(dats))\n      .then(() => this.cleanupDatRegistry())\n      .then(() => this.multidat.getDats())\n      .each(dw => this.registerDat(dw))\n      .each(dw => this.ingestDatContents(dw));\n  }\n\n  // Two functions for adding things into the catalog\n  // Imports a local directory as a dat into the catalog\n  importDir(dir, name = '') {\n    this.multidat.importDir(dir, name)\n      .then(dw => this.registerDat(dw))\n      .then(dw => this.ingestDatContents(dw));\n  }\n\n  // Imports a remote dat repository into the catalog\n  importDat(key, name = '') {\n    this.multidat.importRemoteDat(key, name)\n      .then(dw => this.registerDat(dw))\n      .then(dw => this.ingestDatContents(dw))\n      .catch(Error, () => console.log(`Dat ${key} failed to import.`));\n  }\n\n  // Forks a dat (by its key) into a new, writable dat\n  forkDat(key, name = '') {\n    this.multidat.forkDat(key, name)\n      .then(dw => this.registerDat(dw))\n      .then(dw => this.ingestDatContents(dw));\n  }\n\n  // See db functions in constructor for browsing and searching the catalog.\n\n  // Public call for syncing files within a dat\n  // opts can include {dat:, author: , title:, file: }\n  checkout(opts) {\n    if (!opts) {\n      console.warn('attempted to checkout without opts.');\n      return Promise.reject();\n    }\n    // When the collection option is provided it's handled in a special way\n    // because it is downloading across & within authors and maybe across dats\n    if (opts.collection) {\n      return this.db.getTitlesWith(opts)\n        .then(rows => rows)\n        .each(row => this.download(row.dat, row))\n        .then(() => this.scanForDownloads(opts));\n    }\n    if (opts.dat) {\n      if (typeof opts.dat === 'string') {\n        return this.download(opts.dat, opts)\n          .then(() => this.scanForDownloads(opts, opts.dat));\n      } else if (Array.isArray(opts.dat)) {\n        return Promise.map(opts.dat, dat => this.checkout({ ...opts, dat }));\n      }\n      console.warn('dat option passed to check is not an array or a string');\n      return Promise.reject();\n    }\n    // With no dat provided, we must query for it\n    return this.db.getDatsWith(opts)\n      .map(row => row.dat)\n      .each(dat => this.download(dat, opts)) // .each() passes through the original array\n      .then(dats => this.scanForDownloads(opts, _.uniq(dats)));\n  }\n\n  // ## Dat Management, public functions\n  // Rename a dat - updates DB and dat\n  renameDat(key, name) {\n    const newPath = path.format({\n      dir: this.baseDir,\n      base: name,\n    });\n    return this.multidat.getDat(key)\n      .then(dat => dat.rename(newPath, name))\n      .then(() => this.db.updateDat(key, name, newPath));\n  }\n\n  // Delete a dat from registry.\n  // Only deletes directory if it's in the baseDir\n  removeDat(key, deleteDir = true) {\n    let promise = Promise.resolve();\n    if (deleteDir) {\n      const directory = this.multidat.pathToDat(key);\n      if (directory.startsWith(this.baseDir)) {\n        const rimrafAsync = Promise.promisify(rimraf);\n        promise = this.db.removeDat(key)\n          .then(() => this.db.clearTexts(key))\n          .then(() => rimrafAsync(directory));\n      }\n      /*\n      // @todo: fix this because it is better I think?\n      return this.multidat.pathToDat(key)\n        .then((p) => {\n          if (p.startsWith(this.baseDir)) {\n            return this.db.removeDat(key)\n              .then(() => this.db.clearTexts(key))\n              .then(() => this.multidat.deleteDat(key));\n          }\n          return this.removeDat(key, false);\n        });\n      */\n    }\n    return promise\n      .then(() => this.multidat.removeDat(key))\n      .then(() => this.db.removeDat(key))\n      .then(() => this.db.clearTexts(key));\n  }\n\n  // ### private functions\n  // Remove dats that are in the DB but haven't been found/ loaded by multidat\n  cleanupDatRegistry() {\n    return this.getDats()\n      .map(dats => dats)\n      .filter(dat => !(dat.dat in this.multidat.dats))\n      .each((dat) => {\n        console.log(`Removing: ${chalk.bold(dat.dir)} from catalog (directory does not exist)`);\n        return this.removeDat(dat.dat, false);\n      })\n      .then(() => this.db.clearTexts());\n  }\n\n  // Registers dat the DB\n  registerDat(dw) {\n    const datkey = dw.dat.key.toString('hex');\n    console.log(`Adding dat (${datkey}) to the catalog.`);\n    // listen to events emitted from this dat wrapper\n    dw.on('import', (...args) => this.handleDatImportEvent(...args));\n    dw.on('sync metadata', (...args) => this.handleDatSyncMetadataEvent(...args));\n    dw.on('sync collections', (...args) => this.handleDatSyncCollectionsEvent(...args));\n    dw.on('listing data', (...args) => this.handleDatListingEvent(...args));\n    dw.on('listing end', (...args) => this.handleDatListingEndEvent(...args));\n    dw.on('history data', (...args) => this.handleDatHistoryDataEvent(...args));\n    dw.on('history end', (...args) => this.handleDatHistoryEndEvent(...args));\n    return this.db.removeDat(datkey)\n      // .then(() => this.db.clearTexts(datkey))\n      .then(() => this.db.addDat(datkey, dw.name, dw.directory, dw.version))\n      .then(() => dw)\n      .catch(e => console.log(e));\n  }\n\n  // For a Dat, ingest its collections data (if there are any)\n  ingestDatCollections(dw) {\n    this.db.clearCollections(dw.key)\n      .then(() => dw.listFlattenedCollections())\n      .each(item => this.ingestDatCollectedFile(dw, item[0], item[1]))\n      .catch();\n  }\n\n  ingestDatCollectedFile(dw, file, collectionArr, format = 'authorTitle') {\n    const importedData = parseEntry(file, format);\n    if (importedData) {\n      const collection = collectionArr.join(';;');\n      console.log(chalk.bold('collecting:'), file, collection);\n      return this.db.addCollectedText({\n        dat: dw.key,\n        author: importedData.author,\n        title: importedData.title,\n        collection,\n      });\n    }\n    return Promise.resolve(false);\n  }\n\n  // For a Dat, ingest its contents into the catalog\n  ingestDatContents(dw) {\n    this.queuing.push(dw.key);\n    return this.db.clearTexts(dw.key)\n      .then(() => dw.pumpContents());\n    // return dw.pumpContents();\n    // return dw.replayHistory();\n    // this.db.clearTexts(dw.key)\n      // .then(() => dw.pumpContents(this.ingestDatFile, this));\n      // .then(() => dw.listContents())\n      // .each(file => this.ingestDatFile(dw, file));\n  }\n\n  moveTheQueueAlong(dw) {\n    const batch = this.importQueue.splice(0, this.queueBatchSize);\n    console.log('moving the queue along', batch.length, this.importQueue.length);\n    Promise.map(batch, item => this.ingestDatFile(item[0], item[1]))\n      .filter(item => item)\n      .then(queries => this.db.transact(queries))\n      .finally(() => {\n        if (dw) {\n          const r = this.queuing.indexOf(dw.key);\n          if (r > -1) {\n            this.queuing.splice(r, 1);\n          }\n        }\n      })\n      .catch(() => {});\n      // .then(queries => `${queries.join('; ')};`)\n      // .then(query => this.db.transact(query));\n    // this.queuing = this.queuing - 1;\n  }\n\n  // Adds an entry from a Dat\n  async ingestDatFile(dw, file, format = 'calibre') {\n    const importedData = parseEntry(file, format);\n    if (importedData) {\n      const downloaded = await dw.hasFile(file);\n      const downloadedStr = (downloaded) ? '[*]' : '[ ]';\n      // console.log(chalk.bold('adding:'), downloadedStr, file);\n      const query = this.db.addText({\n        dat: dw.key,\n        author: importedData.author,\n        author_sort: importedData.authorSort,\n        title: importedData.title,\n        file: importedData.file,\n        downloaded,\n      });\n      if (this.queuing.length > 0) {\n        return Promise.resolve(query.toString());\n      }\n      return query;\n    }\n    return Promise.resolve(false);\n  }\n\n  // Downloads files within a dat\n  download(key, opts) {\n    let resource = '';\n    if (opts.author && opts.title && opts.file) {\n      console.log(`checking out ${opts.author}/${opts.title}/${opts.file} from ${key}`);\n      resource = path.join(opts.author, opts.title, opts.file);\n    } else if (opts.author && opts.title) {\n      console.log(`checking out ${opts.author}/${opts.title} from ${key}`);\n      resource = path.join(opts.author, opts.title);\n    } else if (opts.author) {\n      console.log(`checking out ${opts.author} from ${key}`);\n      resource = path.join(opts.author);\n    } else {\n      console.log(`checking out everything from ${opts.dat}`);\n    }\n    return this.multidat.downloadFromDat(key, resource);\n  }\n\n  // Checks whether a group of catalogue items have been downloaded\n  // and if so, then updates the downloaded column in the texts table\n  scanForDownloads(opts, dat) {\n    return this.db.getItemsWith(opts, dat)\n      .then(rows => rows.filter(doc => this.itemIsDownloaded(doc)))\n      .each(row => this.setDownloaded(row.dat, row.author, row.title, row.file));\n  }\n\n  // Given a row from the texts table, check if it has been downloaded\n  itemIsDownloaded(dbRow) {\n    return this.multidat.datHasFile(dbRow.dat, path.join(dbRow.author, dbRow.title, dbRow.file));\n  }\n\n  // Event listening\n  //\n  // When a dat's metadata is synced\n  handleDatSyncMetadataEvent(dw) {\n    console.log('Metadata sync event. Ingesting contents for:', dw.name);\n    this.ingestDatContents(dw);\n  }\n\n  // When a dat imports a file\n  handleDatImportEvent(dw, filePath, stat) {\n    if (this.queuing.includes(dw.key)) {\n      this.importQueue.push([dw, filePath]);\n    } else {\n      this.ingestDatFile(dw, filePath);\n    }\n    // console.log('Importing: ', filePath);\n  }\n\n  // When a dat import process is finished\n  handleDatListingEvent(dw, filePath, stat) {\n    if (this.queuing.includes(dw.key)) {\n      this.importQueue.push([dw, filePath]);\n      if (this.importQueue.length > 0 && this.importQueue.length % this.queueBatchSize === 0) {\n        this.moveTheQueueAlong();\n      }\n    } else {\n      this.ingestDatFile(dw, filePath);\n    }\n    // console.log('Importing: ', filePath);\n  }\n\n  // When a dat import process is finished\n  handleDatListingEndEvent(dw, filePath, stat) {\n    if (this.queuing.includes(dw.key)) {\n      this.moveTheQueueAlong(dw);\n    }\n  }\n\n  handleDatSyncCollectionsEvent(dw) {\n    console.log('Collections sync event. Ingesting collections for:', dw.name);\n    this.ingestDatCollections(dw);\n  }\n\n  // Reading a piece of history data\n  handleDatHistoryDataEvent(dw, data) {\n    if (this.queuing > 0) {\n      this.importQueue.push([dw, data.name]);\n      if (this.importQueue.length % 100 === 0) console.log(this.importQueue.length);\n    } else {\n      console.log('history data:', data.name);\n    }\n  }\n\n  // End event for reading of history data\n  handleDatHistoryEndEvent(dw, data) {\n    console.log('end!!!');\n  }\n}\n\nexport function createCatalog(dataDir, databaseOnlyMode) {\n  // Directory to store all the data in\n  let dataDirFinal = path.join(process.cwd(), config.get('dataDir'));\n  dataDirFinal = dataDir || dataDirFinal;\n\n  // Create data directory if it doesn't exist yet\n  if (!fs.existsSync(dataDirFinal)) {\n    fs.mkdirSync(dataDirFinal);\n  }\n\n  const catalog = new Catalog(dataDirFinal);\n  // @todo: adjust init() to not load any dats, allowing for quick db searches\n  return catalog.init(databaseOnlyMode);\n}\n\nexport default Catalog;\n"]}