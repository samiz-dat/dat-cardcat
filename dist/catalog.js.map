{"version":3,"sources":["../src/catalog.js"],"names":["createCatalog","withinDat","query","dat","where","Array","isArray","whereIn","Catalog","constructor","baseDir","pathIsDownloaded","filePath","existsSync","join","directory","getDats","db","select","getDat","key","dats","client","connection","filename","format","dir","base","useNullAsDefault","isReady","initDatabase","tablesDropped","schema","dropTableIfExists","createTableIfNotExists","table","string","boolean","then","catch","e","console","error","cleanupDatsRegistry","log","map","filter","each","bold","removeDatFromDb","clearDatEntries","discoverDats","name","opts","createIfMissing","sparse","importDat","importDatsFromDB","startsWith","keys","importDir","split","sep","slice","importRemoteDat","resolve","newDat","on","args","handleDatImportEvent","run","registerDat","importFiles","listContents","file","importDatFile","err","dw","datkey","toString","addDatToDb","finally","insert","into","datKey","del","importedData","downloaded","downloadedStr","title_hash","file_hash","author","author_sort","authorSort","title","pathToDat","from","first","checkout","warn","reject","download","scanForDownloads","getDatsWith","row","uniq","getItemsWith","rows","doc","itemIsDownloaded","setDownloaded","downloadContent","dbRow","update","search","s","exp","raw","orWhere","groupBy","orderBy","getAuthors","startingWith","countDistinct","getAuthorLetters","column","distinct","getTitlesForAuthor","getTitlesWith","getFiles","getOpf","mfn","fp","path","stat","dataDir","dataDirFinal","process","cwd","get","mkdirSync","catalog"],"mappings":"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","file":"catalog.js","sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport Promise from 'bluebird';\nimport db from 'knex';\nimport chalk from 'chalk';\nimport _ from 'lodash';\nimport config from './config';\n\nimport DatWrapper, { listDatContents } from './dat'; // this function can be made a method of dat class too.\nimport { opf2js } from './opf';\nimport { getDirectories, notADir } from './utils/filesystem';\nimport parseEntry from './utils/importers';\n// @todo: this.db.close(); should be called on shutdown\n\nfunction withinDat(query, dat) {\n  if (dat) {\n    if (typeof dat === 'string') {\n      query.where('dat', dat);\n    } else if (Array.isArray(dat)) {\n      query.whereIn('dat', dat);\n    }\n  }\n  return query;\n}\n\n// Class definition\nexport class Catalog {\n  constructor(baseDir) {\n    this.baseDir = baseDir;\n    this.dats = [];\n    this.db = db({\n      client: 'sqlite3',\n      connection: {\n        filename: path.format({\n          dir: this.baseDir,\n          base: 'catalog.db',\n        }),\n      },\n      useNullAsDefault: true,\n    });\n    // If you ever need to see what queries are being run uncomment the following.\n    // this.db.on('query', queryData => console.log(queryData));\n    this.isReady = false;\n  }\n\n  initDatabase() {\n    // we should probably setup a simple migration script\n    // but for now lets just drop tables before remaking tables.\n    const tablesDropped = this.db.schema.dropTableIfExists('datsX')\n      .dropTableIfExists('textsX')\n      .dropTableIfExists('more_authorsX');\n    return tablesDropped.createTableIfNotExists('dats', (table) => {\n      table.string('dat');\n      table.string('name');\n      table.string('dir');\n      // table.unique('dat');\n    })\n    .createTableIfNotExists('texts', (table) => {\n      table.string('dat');\n      table.string('title_hash');\n      table.string('file_hash');\n      table.string('author');\n      table.string('author_sort');\n      table.string('title');\n      table.string('file');\n      table.boolean('downloaded');\n    })\n    .createTableIfNotExists('more_authors', (table) => {\n      table.string('title_hash');\n      table.string('author');\n      // table.unique('title_hash');\n    })\n    .then(() => { this.isReady = true; })\n    .catch(e => console.error(e));\n  }\n\n  // Every imported and added dat gets added to the `dats` table of the database. If\n  // the directories are deleted then these db entries are useless and should be removed.\n  // This will simply confirm that every dat directory in the db still exists.\n  cleanupDatsRegistry() {\n    console.log('Cleaning up the dats registry');\n    return this.getDats()\n      .map(dat => dat)\n      .filter(dat => notADir(dat.dir))\n      .each((dat) => {\n        console.log(`Removing: ${chalk.bold(dat.dir)} (directory does not exist)`);\n        return this.removeDatFromDb(dat.dat)\n          .then(() => this.clearDatEntries(dat.dat));\n      })\n      .then(() => this);\n  }\n\n  // Look inside the base directory for any directories that seem to be dats\n  discoverDats() {\n    return getDirectories(this.baseDir)\n      .map((name) => {\n        console.log(`Attempting to load dir: ${chalk.bold(name)} as a dat`);\n        const opts = {\n          name,\n          createIfMissing: false,\n          sparse: true,\n        };\n        return this.importDat(opts);\n      })\n      .then(() => this.cleanupDatsRegistry())\n      .then(() => this.importDatsFromDB())\n      .then(() => this);\n  }\n\n  // Imports dats listed in the dats table of the database\n  importDatsFromDB() {\n    return this.getDats()\n      .map(dat => dat)\n      .filter(dat => notADir(dat.dir)) // directory exists\n      .filter(dat => !dat.dir.startsWith(this.baseDir)) // not in data directory\n      .filter(dat => !(dat.key in this.dats.keys())) // not in registry\n      .each(dat => this.importDir(dat.dir, dat.name))\n      .then(() => console.log('Imported dats from DB'));\n  }\n\n  // Imports a directory on the local filesystem as a dat.\n  // This should not be called on any directories inside `dataDir`, which are loaded differently\n  importDir(directory, name = false) {\n    console.log(`Attempting to import local directory: ${directory}`);\n    const opts = {\n      directory,\n      name: name || directory.split(path.sep).slice(-1)[0],\n    };\n    return this.importDat(opts);\n  }\n\n  // Importing a remote dat by its key\n  importRemoteDat(key, name = false) {\n    console.log(`Attempting to import remote dat: ${key}`);\n    const opts = {\n      key,\n      name: name || key,\n      sparse: true,\n    };\n    return this.importDat(opts);\n  }\n\n  // Does the work of importing a functional dat into the catalog\n  importDat(opts) {\n    if ('key' in opts && opts.key in this.dats) {\n      // The dat is already loaded, we shouldn't reimport it\n      console.log(`You are trying to import a dat that is already loaded: ${opts.key}`);\n      return Promise.resolve(false);\n    }\n    if (!opts.directory) {\n      opts.directory = path.format({\n        dir: this.baseDir,\n        base: (opts.name) ? opts.name : opts.key,\n      });\n    }\n    const newDat = new DatWrapper(opts, this);\n    // listen to events emitted from this dat wrapper\n    newDat.on('import', (...args) => this.handleDatImportEvent(...args));\n    // dw.on('download', (...args) => this.handleDatDownloadEvent(...args));\n    return newDat.run()\n      .then(() => this.registerDat(newDat))\n      .then(() => newDat.importFiles())\n      .then(() => newDat.listContents())\n      .each(file => this.importDatFile(newDat, file))\n      .catch((err) => {\n        console.log(`* Something went wrong when importing ${opts.directory}`);\n        console.log(err);\n      });\n  }\n\n  // Registers dat in catalog array and in database (@todo)\n  registerDat(dw) {\n    const datkey = dw.dat.key.toString('hex');\n    console.log(`Adding dat (${datkey}) to the catalog.`);\n    return this.removeDatFromDb(datkey)\n      .then(() => this.clearDatEntries(datkey))\n      .then(() => this.addDatToDb(datkey, dw.name, dw.directory))\n      .finally(() => { this.dats[datkey] = dw; })\n      .catch(e => console.log(e));\n  }\n\n  addDatToDb(dat, name, dir) {\n    return this.db.insert({ dat, name, dir }).into('dats');\n  }\n\n  removeDatFromDb(datKey) {\n    return this.db('dats').where('dat', datKey).del();\n  }\n\n  // Remove all entries for a dat\n  clearDatEntries(datKey) {\n    return this.db('texts').where('dat', datKey).del();\n  }\n\n  // Adds an entry from a Dat\n  importDatFile(dat, file, format = 'calibre') {\n    const importedData = parseEntry(file, format);\n    if (importedData) {\n      const downloaded = this.pathIsDownloaded(dat, file);\n      const downloadedStr = (downloaded) ? '[*]' : '[ ]';\n      console.log(chalk.bold('adding:'), downloadedStr, file);\n      return this.db.insert({\n        dat: dat.key,\n        title_hash: '',\n        file_hash: '',\n        author: importedData.author,\n        author_sort: importedData.authorSort,\n        title: importedData.title,\n        file: importedData.file,\n        downloaded,\n      }).into('texts');\n    }\n    return Promise.resolve(false);\n  }\n\n  // Returns the path to a dat\n  // This is broken until i can understand making sqlite async\n  pathToDat(datKey) {\n    return this.db.select('dir').from('dats').where('dat', datKey).first();\n  }\n\n  // Public call for syncing files within a dat\n  // opts can include {dat:, author: , title:, file: }\n  checkout(opts) {\n    if (!opts) {\n      console.warn('attempted to checkout without opts.');\n      return Promise.reject();\n    }\n    if (opts.dat) {\n      if (typeof opts.dat === 'string') {\n        return this.download(opts.dat, opts)\n          .then(() => this.scanForDownloads(opts, opts.dat));\n      } else if (Array.isArray(opts.dat)) {\n        return Promise.map(opts.dat, dat => this.checkout({ ...opts, dat }));\n      }\n      console.warn('dat option passed to check is not an array or a string');\n      return Promise.reject();\n    }\n    // With no dat provided, we must query for it\n    return this.getDatsWith(opts)\n      .map(row => row.dat)\n      .each(dat => this.download(dat, opts)) // .each() passes through the original array\n      .then(dats => this.scanForDownloads(opts, _.uniq(dats)));\n  }\n\n  // Checks whether a group of catalogue items have been downloaded\n  // and if so, then updates the downloaded column in the texts table\n  scanForDownloads(opts, dat) {\n    return this.getItemsWith(opts, dat)\n      .then(rows => rows.filter(doc => this.itemIsDownloaded(doc)))\n      .each(row => this.setDownloaded(row.dat, row.author, row.title, row.file));\n  }\n\n  download(dat, opts) {\n    if (opts.author && opts.title && opts.file) {\n      console.log(`checking out ${opts.author}/${opts.title}/${opts.file} from ${dat}`);\n      return this.dats[dat].downloadContent(path.join(opts.author, opts.title, opts.file));\n    } else if (opts.author && opts.title) {\n      console.log(`checking out ${opts.author}/${opts.title} from ${dat}`);\n      return this.dats[dat].downloadContent(path.join(opts.author, opts.title));\n    } else if (opts.author) {\n      console.log(`checking out ${opts.author} from ${dat}`);\n      return this.dats[dat].downloadContent(path.join(opts.author));\n    }\n    // If no opts are provided, but a dat is then download the whole dat\n    console.log(`checking out everything from ${opts.dat}`);\n    return this.dats[dat].downloadContent();\n  }\n\n  // Synchronous\n  pathIsDownloaded = (dat, filePath) => fs.existsSync(path.join(dat.directory, filePath));\n\n  // Given a row from the texts table, check if it has been downloaded\n  itemIsDownloaded(dbRow) {\n    return this.pathIsDownloaded(\n      this.dats[dbRow.dat],\n      path.join(dbRow.author, dbRow.title, dbRow.file));\n  }\n\n  // Sets download status of a row\n  setDownloaded(dat, author, title, file, downloaded = true) {\n    return this.db('texts')\n      .where('dat', dat)\n      .where('author', author)\n      .where('title', title)\n      .where('file', file)\n      .update({\n        downloaded,\n      });\n  }\n\n  // Searches for titles with files bundled up in a comma separated column\n  search(query, dat) {\n    const s = `%${query}%`;\n    const exp = this.db\n      .select('dat',\n        'author',\n        'title',\n        'title_hash',\n        'author_sort',\n      this.db.raw('GROUP_CONCAT(\"file\" || \":\" || \"downloaded\") as \"files\"'))\n      .from('texts')\n      .where(function () { // a bit inelegant but groups where statements\n        this.where('title', 'like', s)\n          .orWhere('author', 'like', s);\n      })\n      .groupBy('author', 'title');\n    withinDat(exp, dat);\n    return exp.orderBy('author_sort', 'title');\n  }\n\n  // Gets a count of authors in the catalog\n  getAuthors(startingWith, dat) {\n    const exp = this.db.select('author').from('texts')\n      .countDistinct('title as count');\n    withinDat(exp, dat);\n    if (startingWith) {\n      const s = `${startingWith}%`;\n      exp.where('author_sort', 'like', s);\n    }\n    return exp\n      .groupBy('author')\n      .orderBy('author_sort');\n  }\n\n  // Gets a list of letters of authors, for generating a directory\n  getAuthorLetters(dat) {\n    const exp = this.db.column(this.db.raw('lower(substr(author_sort,1,1)) as letter'))\n      .select();\n    withinDat(exp, dat);\n    return exp.from('texts')\n      .distinct('letter')\n      .orderBy('letter');\n  }\n\n  getTitlesForAuthor(author, dat) {\n    const exp = this.db('texts')\n      .distinct('dat', 'title')\n      .where('author', author);\n    withinDat(exp, dat);\n    return exp.orderBy('title');\n  }\n\n  // Gets dats containing items described in opts (author/title/file)\n  // Optionally provide one or more dats to look within.\n  getDatsWith(opts, dat) {\n    return this.getItemsWith(opts, dat, 'dat');\n  }\n\n  // Like getItemsWith, except some extra work is done to return titles\n  // along with a comma-separated list of files:downloaded for each title.\n  getTitlesWith(opts, dat) {\n    const exp = this.db\n      .select('dat',\n        'author',\n        'title',\n        'title_hash',\n        'author_sort',\n      this.db.raw('GROUP_CONCAT(\"file\" || \":\" || \"downloaded\") as \"files\"'))\n      .from('texts');\n    if (opts.author) {\n      exp.where('author', opts.author);\n    }\n    if (opts.title) {\n      exp.where('title', opts.title);\n    }\n    withinDat(exp, dat);\n    return exp\n      .groupBy('author', 'title')\n      .orderBy('author_sort', 'title');\n  }\n\n  // Gets entire entries for catalog items matching author/title/file.\n  // Can specify a dat or a list of dats to get within.\n  getItemsWith(opts, dat, distinct) {\n    const exp = this.db('texts');\n    if (distinct) {\n      exp.distinct(distinct);\n    }\n    if (opts.author) {\n      exp.where('author', opts.author);\n    }\n    if (opts.title) {\n      exp.where('title', opts.title);\n    }\n    if (opts.file) {\n      exp.where('file', opts.file);\n    }\n    withinDat(exp, dat);\n    return exp.orderBy('dat', 'author', 'title');\n  }\n\n  // Optionally only include files from a particular dat.\n  // Optionally specify a filename to find.\n  getFiles(author, title, dat, file) {\n    const exp = this.db('texts')\n      .where('author', author)\n      .where('title', title);\n    withinDat(exp, dat);\n    if (file) {\n      exp.where('file', file);\n    }\n    return exp.orderBy('dat', 'file');\n  }\n\n  getDats = () => this.db('dats').select();\n  getDat = key => this.db('dats').select().where('dat', key);\n\n  // Returns opf metadata object for an item, optionally preferring a specific library.\n  getOpf(author, title, dat = false) {\n    const mfn = 'metadata.opf'; // metadata file name\n    return this.getFiles(author, title, dat, mfn).first()\n      .then(row => this.pathToDat(row.dat))\n      .then(fp => opf2js(path.join(fp.dir, author, title, mfn)));\n  }\n\n  // Event listening\n  //\n  // When a dat imports a file\n  handleDatImportEvent(dw, path, stat) {\n    // console.log('Importing: ', path);\n  }\n}\n\nexport function createCatalog(dataDir) {\n  // Directory to store all the data in\n  let dataDirFinal = path.join(process.cwd(), config.get('dataDir'));\n  dataDirFinal = dataDir || dataDirFinal;\n\n  // Create data directory if it doesn't exist yet\n  if (!fs.existsSync(dataDirFinal)) {\n    fs.mkdirSync(dataDirFinal);\n  }\n\n  const catalog = new Catalog(dataDirFinal);\n  return catalog.initDatabase().then(() => catalog);\n}\n\nexport default Catalog;\n"]}